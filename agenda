<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lava Carros — Gestão Autônoma</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#6b7280; --text:#e5e7eb;
      --primary:#22c55e; --danger:#ef4444; --warn:#f59e0b; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background:linear-gradient(180deg,#0b1224,#0f172a 40%,#0b1224);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:blur(8px);
      background:rgba(15,23,42,.7); border-bottom:1px solid #1f2937;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:12px 16px}
    .brand{display:flex; align-items:center; gap:10px}
    .brand h1{font-size:18px; margin:0}
    .nav{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px
    }
    .nav button{
      padding:8px 12px; border:1px solid #1f2937; background:#0b1224;
      color:var(--text); border-radius:8px; cursor:pointer
    }
    .nav button.active{background:var(--accent); color:#06243a; border-color:#0ea5e9}
    main{padding:16px}
    .grid{
      display:grid; gap:16px;
      grid-template-columns:1fr;
    }
    @media(min-width:900px){
      .grid{grid-template-columns:1.2fr .8fr}
    }
    .card{
      background:var(--card); border:1px solid #1f2937; border-radius:12px;
      padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    h2{margin:0 0 10px 0; font-size:18px}
    h3{margin:0 0 8px 0; font-size:16px; color:#cbd5e1}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px; border-radius:8px; border:1px solid #334155;
      background:#0b1224; color:var(--text); margin-bottom:10px
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .btn{
      padding:10px 12px; border-radius:8px; border:1px solid #1f2937;
      background:var(--primary); color:#06243a; font-weight:600; cursor:pointer
    }
    .btn.secondary{background:#0b1224; color:var(--text)}
    .btn.danger{background:var(--danger); color:#fff}
    .btn.warn{background:var(--warn); color:#06243a}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{border-bottom:1px solid #1f2937; padding:8px; text-align:left}
    th{color:#cbd5e1}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px}
    .pill.ok{background:#064e3b; color:#a7f3d0}
    .pill.low{background:#3f2d0f; color:#fde68a}
    .pill.out{background:#4c0519; color:#fecdd3}
    .kpi{
      display:grid; grid-template-columns:repeat(2,1fr); gap:10px
    }
    @media(min-width:700px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .kpi .item{
      background:#0b1224; border:1px solid #1f2937; border-radius:10px; padding:12px
    }
    .muted{color:var(--muted)}
    .footer{margin-top:20px; font-size:12px; color:#94a3b8}
    .alert{background:#1f2937; border-left:4px solid var(--warn); padding:10px; border-radius:8px; margin-bottom:10px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 6h18l-2 10H5L3 6z" stroke="#38bdf8" stroke-width="1.5"/><circle cx="7" cy="18" r="2" fill="#22c55e"/><circle cx="17" cy="18" r="2" fill="#22c55e"/></svg>
        <h1>Lava Carros — Gestão Autônoma</h1>
      </div>
      <div class="nav">
        <button data-tab="agenda" class="active">Agenda</button>
        <button data-tab="funcionarios">Funcionários</button>
        <button data-tab="estoque">Estoque</button>
        <button data-tab="relatorios">Relatórios</button>
        <button data-tab="config">Configurações</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Agenda -->
    <section id="agenda" class="tab">
      <div class="grid">
        <div class="card">
          <h2>Novo agendamento</h2>
          <div class="alert hidden" id="agendaAlert"></div>
          <div class="row">
            <div>
              <label>Cliente</label>
              <input id="agCliente" placeholder="Nome do cliente" />
            </div>
            <div>
              <label>Telefone</label>
              <input id="agTelefone" placeholder="(xx) xxxxx-xxxx" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Data</label>
              <input id="agData" type="date" />
            </div>
            <div>
              <label>Hora</label>
              <input id="agHora" type="time" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Serviço</label>
              <select id="agServico">
                <option value="Lavagem simples">Lavagem simples</option>
                <option value="Lavagem completa">Lavagem completa</option>
                <option value="Higienização interna">Higienização interna</option>
                <option value="Polimento">Polimento</option>
              </select>
            </div>
            <div>
              <label>Funcionário</label>
              <select id="agFuncionario"></select>
            </div>
          </div>
          <label>Observações</label>
          <textarea id="agObs" rows="3" placeholder="Detalhes do veículo, placa, preferências..."></textarea>
          <div class="row">
            <button class="btn" id="agSalvar">Salvar agendamento</button>
            <button class="btn secondary" id="agLimpar">Limpar</button>
          </div>
        </div>

        <div class="card">
          <h2>Agenda do dia</h2>
          <div class="row">
            <div>
              <label>Filtrar por data</label>
              <input id="agFiltroData" type="date" />
            </div>
            <div>
              <label>Status</label>
              <select id="agFiltroStatus">
                <option value="">Todos</option>
                <option value="Pendente">Pendente</option>
                <option value="Em andamento">Em andamento</option>
                <option value="Concluído">Concluído</option>
                <option value="Cancelado">Cancelado</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Hora</th><th>Cliente</th><th>Serviço</th><th>Funcionário</th><th>Status</th><th>Ações</th>
              </tr>
            </thead>
            <tbody id="agLista"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Funcionários -->
    <section id="funcionarios" class="tab hidden">
      <div class="grid">
        <div class="card">
          <h2>Cadastrar funcionário</h2>
          <div class="row">
            <div>
              <label>Nome</label>
              <input id="fnNome" placeholder="Nome completo" />
            </div>
            <div>
              <label>Cargo</label>
              <select id="fnCargo">
                <option>Atendente</option>
                <option>Lavador</option>
                <option>Supervisor</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Telefone</label>
              <input id="fnTelefone" placeholder="(xx) xxxxx-xxxx" />
            </div>
            <div>
              <label>Status</label>
              <select id="fnStatus">
                <option>Ativo</option>
                <option>Férias</option>
                <option>Inativo</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button class="btn" id="fnSalvar">Salvar</button>
            <button class="btn secondary" id="fnLimpar">Limpar</button>
          </div>
        </div>

        <div class="card">
          <h2>Equipe</h2>
          <table>
            <thead>
              <tr><th>Nome</th><th>Cargo</th><th>Status</th><th>Ações</th></tr>
            </thead>
            <tbody id="fnLista"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Estoque -->
    <section id="estoque" class="tab hidden">
      <div class="grid">
        <div class="card">
          <h2>Adicionar produto</h2>
          <div class="row">
            <div>
              <label>Produto</label>
              <input id="esNome" placeholder="Ex.: Shampoo automotivo" />
            </div>
            <div>
              <label>Categoria</label>
              <select id="esCategoria">
                <option>Limpeza</option>
                <option>Acabamento</option>
                <option>Equipamentos</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Quantidade</label>
              <input id="esQtd" type="number" min="0" value="0" />
            </div>
            <div>
              <label>Estoque mínimo</label>
              <input id="esMin" type="number" min="0" value="5" />
            </div>
          </div>
          <div class="row">
            <button class="btn" id="esSalvar">Salvar</button>
            <button class="btn secondary" id="esLimpar">Limpar</button>
          </div>
        </div>

        <div class="card">
          <h2>Produtos</h2>
          <div id="esAlert" class="alert hidden"></div>
          <table>
            <thead>
              <tr><th>Produto</th><th>Categoria</th><th>Qtd</th><th>Status</th><th>Ações</th></tr>
            </thead>
            <tbody id="esLista"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Relatórios -->
    <section id="relatorios" class="tab hidden">
      <div class="card">
        <h2>KPIs e desempenho</h2>
        <div class="kpi">
          <div class="item">
            <div class="muted">Serviços hoje</div>
            <div id="kpiServicos" style="font-size:22px; font-weight:700">0</div>
          </div>
          <div class="item">
            <div class="muted">Taxa de ocupação</div>
            <div id="kpiOcupacao" style="font-size:22px; font-weight:700">0%</div>
          </div>
          <div class="item">
            <div class="muted">Ticket médio</div>
            <div id="kpiTicket" style="font-size:22px; font-weight:700">R$ 0,00</div>
          </div>
          <div class="item">
            <div class="muted">Produtos em baixa</div>
            <div id="kpiBaixa" style="font-size:22px; font-weight:700">0</div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="card">
          <h3>Produtividade por funcionário (últimos 7 dias)</h3>
          <table>
            <thead><tr><th>Funcionário</th><th>Serviços</th></tr></thead>
            <tbody id="repProd"></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Receita por serviço (últimos 30 dias)</h3>
          <table>
            <thead><tr><th>Serviço</th><th>Qtd</th><th>Receita</th></tr></thead>
            <tbody id="repReceita"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Configurações -->
    <section id="config" class="tab hidden">
      <div class="grid">
        <div class="card">
          <h2>Tabela de preços</h2>
          <div id="precosForm"></div>
          <button class="btn" id="precosSalvar">Salvar preços</button>
        </div>
        <div class="card">
          <h2>Automação</h2>
          <p class="muted">Alertas de estoque baixo e taxa de ocupação diária.</p>
          <div class="row">
            <div>
              <label>Capacidade diária (vagas)</label>
              <input id="cfgCapacidade" type="number" min="1" value="12" />
            </div>
            <div>
              <label>Limite alerta ocupação (%)</label>
              <input id="cfgLimiteOcup" type="number" min="10" max="100" value="80" />
            </div>
          </div>
          <button class="btn warn" id="cfgTestarAlertas">Testar alertas</button>
          <button class="btn danger" id="cfgReset">Resetar dados</button>
          <div id="cfgAlert" class="alert hidden" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="footer">Versão 1.0 — Dados locais no navegador</div>
    </section>
  </main>

  <script>
    // ---------- Utilidades ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const fmtBRL = v => (new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'})).format(v||0);
    const todayStr = () => new Date().toISOString().slice(0,10);

    const store = {
      get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    };

    // ---------- Estado ----------
    const state = {
      funcionarios: store.get('funcionarios', [
        {id:1, nome:'João Silva', cargo:'Lavador', telefone:'', status:'Ativo'},
        {id:2, nome:'Maria Souza', cargo:'Atendente', telefone:'', status:'Ativo'}
      ]),
      agenda: store.get('agenda', []),
      estoque: store.get('estoque', [
        {id:1, nome:'Shampoo automotivo', categoria:'Limpeza', qtd:12, min:5},
        {id:2, nome:'Cera líquida', categoria:'Acabamento', qtd:4, min:5}
      ]),
      precos: store.get('precos', {
        'Lavagem simples': 35,
        'Lavagem completa': 60,
        'Higienização interna': 120,
        'Polimento': 200
      }),
      cfg: store.get('cfg', {capacidade:12, limiteOcup:80})
    };

    const persist = () => {
      store.set('funcionarios', state.funcionarios);
      store.set('agenda', state.agenda);
      store.set('estoque', state.estoque);
      store.set('precos', state.precos);
      store.set('cfg', state.cfg);
      
    };

    // ---------- Navegação ----------
    $$('.nav button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        $$('.tab').forEach(s=>s.classList.add('hidden'));
        document.getElementById(tab).classList.remove('hidden');
      });
    });

    // ---------- Agenda ----------
    function renderAgendaFuncionarioOptions(){
      const sel = $('#agFuncionario');
      sel.innerHTML = '';
      state.funcionarios.filter(f=>f.status==='Ativo').forEach(f=>{
        const opt = document.createElement('option');
        opt.value = f.id; opt.textContent = f.nome;
        sel.appendChild(opt);
      });
    }

    function renderAgendaList(){
      const tbody = $('#agLista');
      tbody.innerHTML = '';
      const fData = $('#agFiltroData').value || todayStr();
      const fStatus = $('#agFiltroStatus').value;
      const items = state.agenda
        .filter(a=>a.data===fData && (!fStatus || a.status===fStatus))
        .sort((a,b)=>a.hora.localeCompare(b.hora));
      items.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.hora}</td>
          <td>${a.cliente}<div class="muted" style="font-size:12px">${a.telefone||''}</div></td>
          <td>${a.servico}</td>
          <td>${(state.funcionarios.find(f=>f.id==a.funcionarioId)||{}).nome||'-'}</td>
          <td>
            <select data-id="${a.id}" class="agStatus">
              ${['Pendente','Em andamento','Concluído','Cancelado'].map(s=>`<option ${s===a.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td>
            <button class="btn secondary" data-edit="${a.id}">Editar</button>
            <button class="btn danger" data-del="${a.id}">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Eventos linha
      $$('.agStatus').forEach(sel=>{
        sel.addEventListener('change', e=>{
          const id = +e.target.dataset.id;
          const item = state.agenda.find(x=>x.id===id);
          item.status = e.target.value;
          persist();
        });
      });
      $$('#agLista [data-del]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.del;
          state.agenda = state.agenda.filter(x=>x.id!==id);
          persist();
        });
      });
      $$('#agLista [data-edit]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.edit;
          const a = state.agenda.find(x=>x.id===id);
          $('#agCliente').value = a.cliente;
          $('#agTelefone').value = a.telefone;
          $('#agData').value = a.data;
          $('#agHora').value = a.hora;
          $('#agServico').value = a.servico;
          $('#agFuncionario').value = a.funcionarioId;
          $('#agObs').value = a.obs||'';
          $('#agSalvar').dataset.editing = id;
          $('#agendaAlert').classList.remove('hidden');
          $('#agendaAlert').textContent = 'Editando agendamento — salve para confirmar.';
        });
      });

      // Alerta ocupação
      const ocupacao = Math.round((items.length / state.cfg.capacidade) * 100);
      if(ocupacao >= state.cfg.limiteOcup){
        $('#agendaAlert').classList.remove('hidden');
        $('#agendaAlert').textContent = `Alerta: ocupação de ${ocupacao}% para ${fData}. Considere ajustar horários ou equipe.`;
      }else{
        if(!$('#agSalvar').dataset.editing) $('#agendaAlert').classList.add('hidden');
      }
    }

    function clearAgendaForm(){
      ['agCliente','agTelefone','agData','agHora','agObs'].forEach(id=>$( '#'+id ).value='');
      $('#agServico').value='Lavagem simples';
      const firstFn = $('#agFuncionario').querySelector('option');
      if(firstFn) $('#agFuncionario').value = firstFn.value;
      delete $('#agSalvar').dataset.editing;
      $('#agendaAlert').classList.add('hidden');
    }

    $('#agSalvar').addEventListener('click', ()=>{
      const cliente = $('#agCliente').value.trim();
      const telefone = $('#agTelefone').value.trim();
      const data = $('#agData').value || todayStr();
      const hora = $('#agHora').value || '08:00';
      const servico = $('#agServico').value;
      const funcionarioId = +$('#agFuncionario').value;
      const obs = $('#agObs').value.trim();

      if(!cliente){ alert('Informe o nome do cliente.'); return; }

      const editing = +($('#agSalvar').dataset.editing||0);
      if(editing){
        const a = state.agenda.find(x=>x.id===editing);
        Object.assign(a, {cliente, telefone, data, hora, servico, funcionarioId, obs});
      }else{
        const id = Date.now();
        state.agenda.push({id, cliente, telefone, data, hora, servico, funcionarioId, obs, status:'Pendente', valor: state.precos[servico]||0});
      }
      persist();
      clearAgendaForm();
    });

    $('#agLimpar').addEventListener('click', clearAgendaForm);
    $('#agFiltroData').addEventListener('change', renderAgendaList);
    $('#agFiltroStatus').addEventListener('change', renderAgendaList);

    // ---------- Funcionários ----------
    function renderFuncionarios(){
      const tbody = $('#fnLista');
      tbody.innerHTML = '';
      state.funcionarios.forEach(f=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.nome}<div class="muted" style="font-size:12px">${f.telefone||''}</div></td>
          <td>${f.cargo}</td>
          <td>${f.status}</td>
          <td>
            <button class="btn secondary" data-edit="${f.id}">Editar</button>
            <button class="btn danger" data-del="${f.id}">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      $$('#fnLista [data-del]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.del;
          state.funcionarios = state.funcionarios.filter(x=>x.id!==id);
          persist();
          renderAgendaFuncionarioOptions();
        });
      });
      $$('#fnLista [data-edit]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.edit;
          const f = state.funcionarios.find(x=>x.id===id);
          $('#fnNome').value = f.nome;
          $('#fnCargo').value = f.cargo;
          $('#fnTelefone').value = f.telefone||'';
          $('#fnStatus').value = f.status;
          $('#fnSalvar').dataset.editing = id;
        });
      });
    }

    function clearFnForm(){
      ['fnNome','fnTelefone'].forEach(id=>$('#'+id).value='');
      $('#fnCargo').value='Atendente';
      $('#fnStatus').value='Ativo';
      delete $('#fnSalvar').dataset.editing;
    }

    $('#fnSalvar').addEventListener('click', ()=>{
      const nome = $('#fnNome').value.trim();
      const cargo = $('#fnCargo').value;
      const telefone = $('#fnTelefone').value.trim();
      const status = $('#fnStatus').value;
      if(!nome){ alert('Informe o nome.'); return; }
      const editing = +($('#fnSalvar').dataset.editing||0);
      if(editing){
        const f = state.funcionarios.find(x=>x.id===editing);
        Object.assign(f, {nome, cargo, telefone, status});
      }else{
        const id = Date.now();
        state.funcionarios.push({id, nome, cargo, telefone, status});
      }
      persist();
      renderAgendaFuncionarioOptions();
      clearFnForm();
    });

    $('#fnLimpar').addEventListener('click', clearFnForm);

    // ---------- Estoque ----------
    function statusPill(qtd, min){
      if(qtd<=0) return '<span class="pill out">Esgotado</span>';
      if(qtd<=min) return '<span class="pill low">Baixo</span>';
      return '<span class="pill ok">OK</span>';
    }

    function renderEstoque(){
      const tbody = $('#esLista');
      tbody.innerHTML = '';
      const low = [];
      state.estoque.forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.categoria}</td>
          <td>
            <div class="row" style="gap:6px">
              <input type="number" min="0" value="${p.qtd}" data-qtd="${p.id}" style="max-width:100px"/>
              <button class="btn secondary" data-inc="${p.id}">+1</button>
              <button class="btn secondary" data-dec="${p.id}">-1</button>
            </div>
          </td>
          <td>${statusPill(p.qtd, p.min)}</td>
          <td>
            <button class="btn secondary" data-edit="${p.id}">Editar</button>
            <button class="btn danger" data-del="${p.id}">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
        if(p.qtd<=p.min) low.push(p);
      });

      // Alertas
      const alert = $('#esAlert');
      if(low.length){
        alert.classList.remove('hidden');
        alert.textContent = `Atenção: ${low.length} produto(s) com estoque baixo — ${low.map(x=>x.nome).join(', ')}.`;
      }else{
        alert.classList.add('hidden');
      }

      // Eventos
      $$('#esLista [data-del]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.del;
          state.estoque = state.estoque.filter(x=>x.id!==id);
          persist();
        });
      });
      $$('#esLista [data-edit]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.edit;
          const p = state.estoque.find(x=>x.id===id);
          $('#esNome').value = p.nome;
          $('#esCategoria').value = p.categoria;
          $('#esQtd').value = p.qtd;
          $('#esMin').value = p.min;
          $('#esSalvar').dataset.editing = id;
        });
      });
      $$('#esLista [data-inc]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.inc;
          const p = state.estoque.find(x=>x.id===id);
          p.qtd++; persist();
        });
      });
      $$('#esLista [data-dec]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = +e.target.dataset.dec;
          const p = state.estoque.find(x=>x.id===id);
          p.qtd = Math.max(0, p.qtd-1); persist();
        });
      });
      $$('#esLista [data-qtd]').forEach(inp=>{
        inp.addEventListener('change', e=>{
          const id = +e.target.dataset.qtd;
          const p = state.estoque.find(x=>x.id===id);
          p.qtd = Math.max(0, +e.target.value||0); persist();
        });
      });
    }

    function clearEsForm(){
      ['esNome'].forEach(id=>$('#'+id).value='');
      $('#esCategoria').value='Limpeza';
      $('#esQtd').value=0; $('#esMin').value=5;
      delete $('#esSalvar').dataset.editing;
    }

    $('#esSalvar').addEventListener('click', ()=>{
      const nome = $('#esNome').value.trim();
      const categoria = $('#esCategoria').value;
      const qtd = Math.max(0, +$('#esQtd').value||0);
      const min = Math.max(0, +$('#esMin').value||0);
      if(!nome){ alert('Informe o nome do produto.'); return; }
      const editing = +($('#esSalvar').dataset.editing||0);
      if(editing){
        const p = state.estoque.find(x=>x.id===editing);
        Object.assign(p, {nome, categoria, qtd, min});
      }else{
        const id = Date.now();
        state.estoque.push({id, nome, categoria, qtd, min});
      }
      persist();
      clearEsForm();
    });

    $('#esLimpar').addEventListener('click', clearEsForm);

    // ---------- Relatórios ----------
    function renderKPIs(){
      const hoje = todayStr();
      const hojeAg = state.agenda.filter(a=>a.data===hoje);
      $('#kpiServicos').textContent = hojeAg.length;
      const ocup = Math.round((hojeAg.length/state.cfg.capacidade)*100);
      $('#kpiOcupacao').textContent = `${isFinite(ocup)?ocup:0}%`;
      const ticketMedio = hojeAg.length ? (hojeAg.reduce((s,a)=>s+(a.valor||0),0)/hojeAg.length) : 0;
      $('#kpiTicket').textContent = fmtBRL(ticketMedio);
      const baixa = state.estoque.filter(p=>p.qtd<=p.min).length;
      $('#kpiBaixa').textContent = baixa;
    }

    function renderProdutividade(){
      const tbody = $('#repProd');
      tbody.innerHTML = '';
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-7);
      const map = {};
      state.agenda.forEach(a=>{
        const d = new Date(a.data);
        if(d>=cutoff && a.status==='Concluído'){
          map[a.funcionarioId] = (map[a.funcionarioId]||0)+1;
        }
      });
      state.funcionarios.forEach(f=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${f.nome}</td><td>${map[f.id]||0}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderReceita(){
      const tbody = $('#repReceita');
      tbody.innerHTML = '';
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-30);
      const map = {};
      state.agenda.forEach(a=>{
        const d = new Date(a.data);
        if(d>=cutoff && a.status==='Concluído'){
          const k = a.servico;
          map[k] = map[k]||{qtd:0, receita:0};
          map[k].qtd++; map[k].receita += (a.valor||0);
        }
      });
      Object.entries(map).forEach(([serv, obj])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${serv}</td><td>${obj.qtd}</td><td>${fmtBRL(obj.receita)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ---------- Configurações ----------
    function renderPrecosForm(){
      const cont = $('#precosForm');
      cont.innerHTML = '';
      Object.entries(state.precos).forEach(([serv, val])=>{
        const wrap = document.createElement('div');
        wrap.className='row';
        wrap.innerHTML = `
          <div><label>${serv}</label><input type="number" min="0" value="${val}" data-preco="${serv}"/></div>
        `;
        cont.appendChild(wrap);
      });
    }

    $('#precosSalvar').addEventListener('click', ()=>{
      $$('#precosForm [data-preco]').forEach(inp=>{
        const serv = inp.dataset.preco;
        state.precos[serv] = Math.max(0, +inp.value||0);
      });
      // Atualiza valores dos agendamentos futuros
      state.agenda.forEach(a=>{
        a.valor = state.precos[a.servico]||0;
      });
      persist();
      alert('Tabela de preços atualizada.');
    });

    $('#cfgTestarAlertas').addEventListener('click', ()=>{
      const hoje = todayStr();
      const ocupacao = Math.round((state.agenda.filter(a=>a.data===hoje).length/state.cfg.capacidade)*100);
      const low = state.estoque.filter(p=>p.qtd<=p.min).map(p=>p.nome);
      const msgs = [];
      if(ocupacao>=state.cfg.limiteOcup) msgs.push(`Ocupação alta hoje: ${ocupacao}%`);
      if(low.length) msgs.push(`Estoque baixo: ${low.join(', ')}`);
      const box = $('#cfgAlert');
      if(msgs.length){
        box.classList.remove('hidden');
        box.textContent = msgs.join(' | ');
      }else{
        box.classList.remove('hidden');
        box.textContent = 'Tudo ok — sem alertas no momento.';
      }
    });

    $('#cfgReset').addEventListener('click', ()=>{
      if(!confirm('Tem certeza que deseja resetar todos os dados?')) return;
      localStorage.clear();
      location.reload();
    });

    // ---------- Render ----------
    function renderAll(){
      renderAgendaFuncionarioOptions();
      renderAgendaList();
      renderFuncionarios();
      renderEstoque();
      renderKPIs();
      renderProdutividade();
      renderReceita();
      renderPrecosForm();
      $('#cfgCapacidade').value = state.cfg.capacidade;
      $('#cfgLimiteOcup').value = state.cfg.limiteOcup;
    }

    // Inputs config
    $('#cfgCapacidade').addEventListener('change', e=>{
      state.cfg.capacidade = Math.max(1, +e.target.value||1);
      persist();
    });
    $('#cfgLimiteOcup').addEventListener('change', e=>{
      state.cfg.limiteOcup = Math.min(100, Math.max(10, +e.target.value||80));
      persist();
    });
    
    // Inicialização
    $('#agFiltroData').value = todayStr();
    renderAll();
    </script>
</body>
</html>
  <style>
    :root{
      --text:#e2e8f0;
      --muted:#94a3b8;
      --card:#1e293b;
      --primary:#38bdf8;
      --accent:#7dd3fc;
      --danger:#ef4444;
      --warn:#facc15;
    }
    *{box-sizing:border-box; font-family:Arial, sans-serif}
    body{
      margin:0; padding:0; background:#0b1224; color:var(--text);
      min-height:100vh; display:flex; flex-direction:column; 
    }
    header{
      border-bottom:1px solid #1f2937; padding:12px 0; background:#111827;
    }
    .wrap{
      width:90%; max-width:1200px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .brand h1{
      font-size:20px; margin:0; font-weight:600; color:var(--primary);
    }
